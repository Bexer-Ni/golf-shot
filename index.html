<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Shot Decision Assistant (‡∏Å‡∏≠‡∏•‡πå‡∏ü)</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8; --good:#34d399; --bad:#f87171; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "TH Sarabun New", "Noto Sans Thai", sans-serif; background: linear-gradient(180deg, #0b1220, #0f172a 60%); color: var(--text); }
  header { padding: 20px 16px 8px; position: sticky; top:0; background: rgba(15,23,42,0.85); backdrop-filter: blur(6px); border-bottom: 1px solid #1f2937; z-index: 10; }
  header h1 { margin:0; font-size: 20px; letter-spacing: 0.3px; }
  header p { margin:6px 0 0; color: var(--muted); font-size: 13px; }
  main { padding: 16px; max-width: 1080px; margin: 0 auto; }
  .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
  .card { background: linear-gradient(180deg, #0b1020, #0d1323); border: 1px solid #1f2937; border-radius: 12px; padding: 14px; box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
  .card h2 { font-size: 16px; margin:0 0 8px; letter-spacing: 0.3px; }
  .card p { margin: 6px 0; color: var(--muted); font-size: 13px; }
  label { display:block; font-size: 13px; color: #cbd5e1; margin: 8px 0 4px; }
  select, input[type="number"], input[type="range"] { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #334155; background:#0b1220; color: var(--text); }
  .row { display:flex; gap:10px; }
  .row > * { flex:1; }
  button { cursor:pointer; border:1px solid #334155; background:#0b1220; color:var(--text); padding:10px 12px; border-radius:10px; font-weight:600; }
  button.primary { background: linear-gradient(180deg, #0891b2, #0284c7); border: none; }
  button.good { background: linear-gradient(180deg, #10b981, #059669); border: none; }
  button.bad { background: linear-gradient(180deg, #ef4444, #dc2626); border: none; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #334155; color:#cbd5e1; }
  .output { font-size: 14px; line-height: 1.55; }
  ul { margin: 8px 0 0 18px; }
  .tag { font-size: 11px; color: var(--muted); display:inline-block; padding:2px 8px; border:1px solid #334155; border-radius:999px; margin-right:6px; }
  .footer { margin-top: 10px; font-size: 12px; color: var(--muted); }
  .small { font-size: 12px; color:#cbd5e1; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  details { border:1px solid #334155; border-radius:10px; padding:10px 12px; background: #0b1220; }
  summary { cursor:pointer; font-weight:700; }
  .divider { height:1px; background:#1f2937; margin: 10px 0; }
  .badge { background:#0b1220; border:1px solid #334155; font-size:11px; padding:4px 8px; border-radius:999px; display:inline-block; margin-right:6px; color:#cbd5e1; }
  .right { text-align:right; }
  .muted { color: var(--muted); }
</style>
</head>
<body>
<header>
  <h1>Shot Decision Assistant ‚Ä¢ ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô MVP</h1>
  <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏ä‡πá‡∏≠‡∏ï ‚ûù ‡∏Å‡∏î ‚Äú‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ‚Äù ‚ûù ‡∏ï‡∏µ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ú‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏û‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏≤‡∏Ñ‡∏∏‡∏ì</p>
</header>

<main>
  <div class="grid">
    <div class="card" style="grid-column: span 5;">
      <h2>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏ä‡πá‡∏≠‡∏ï (Conditions)</h2>
      <div class="row">
        <div>
          <label>Lie</label>
          <select id="lie">
            <option>‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå</option>
            <option>‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏ö‡∏≤‡∏á)</option>
            <option>‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏´‡∏ô‡∏≤)</option>
            <option>‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option>
            <option>‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå</option>
            <option>‡∏ü‡∏£‡∏¥‡∏ô‡∏à‡πå/‡πÄ‡∏≠‡∏û‡∏û‡πÇ‡∏£‡∏ä</option>
            <option>‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü</option>
          </select>
        </div>
        <div>
          <label>‡∏£‡∏∞‡∏¢‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤ (‡πÄ‡∏°‡∏ï‡∏£)</label>
          <input id="dist" type="number" min="5" max="250" step="1" value="120">
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ô ‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á‡πÄ‡∏ô‡∏¥‡∏ô</label>
          <select id="slopeY">
            <option value="flat">‡∏û‡∏∑‡πâ‡∏ô‡∏£‡∏≤‡∏ö</option>
            <option value="up_lite">‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="up_big">‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ô‡∏¥‡∏ô‡∏°‡∏≤‡∏Å</option>
            <option value="down_lite">‡∏•‡∏á‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="down_big">‡∏•‡∏á‡πÄ‡∏ô‡∏¥‡∏ô‡∏°‡∏≤‡∏Å</option>
          </select>
        </div>
        <div>
          <label>‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤</label>
          <select id="slopeX">
            <option value="level">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏ó‡πâ‡∏≤</option>
            <option value="above_lite">‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="above_big">‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤‡∏°‡∏≤‡∏Å</option>
            <option value="below_lite">‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="below_big">‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤‡∏°‡∏≤‡∏Å</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏•‡∏°</label>
          <select id="wind">
            <option value="calm">‡∏•‡∏°‡∏™‡∏á‡∏ö</option>
            <option value="head_lite">‡∏•‡∏°‡∏ï‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="head_big">‡∏•‡∏°‡∏ï‡πâ‡∏≤‡∏ô‡πÅ‡∏£‡∏á</option>
            <option value="tail_lite">‡∏•‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
            <option value="tail_big">‡∏•‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏£‡∏á</option>
            <option value="cross">‡∏•‡∏°‡∏Ç‡∏ß‡∏≤‡∏á</option>
          </select>
        </div>
        <div>
          <label>‡∏™‡∏†‡∏≤‡∏û‡∏•‡∏π‡∏Å</label>
          <select id="ball">
            <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option value="sitting">‡∏•‡∏≠‡∏¢‡∏ö‡∏ô‡∏´‡∏ç‡πâ‡∏≤</option>
            <option value="down">‡∏à‡∏°/‡∏ù‡∏±‡∏á</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô</label>
          <select id="turf">
            <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option>
            <option value="firm">‡πÅ‡∏Ç‡πá‡∏á</option>
            <option value="soft">‡∏ô‡∏∏‡πà‡∏°/‡∏ä‡∏∑‡πâ‡∏ô</option>
          </select>
        </div>
        <div>
          <label>‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</label>
          <select id="obs">
            <option value="none">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
            <option value="carry">‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</option>
            <option value="low">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏û‡∏∏‡πà‡∏á‡∏ï‡πà‡∏≥</option>
            <option value="high">‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏û/‡∏¢‡∏Å‡∏™‡∏π‡∏á</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô</label>
          <select id="stance">
            <option value="stable">‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á</option>
            <option value="unstable">‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á</option>
          </select>
        </div>
        <div>
          <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ò‡∏á</label>
          <select id="pin">
            <option value="center">‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option>
            <option value="front">‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏µ‡∏ô</option>
            <option value="back">‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option>
            <option value="left">‡∏ã‡πâ‡∏≤‡∏¢</option>
            <option value="right">‡∏Ç‡∏ß‡∏≤</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>
      <div class="row">
        <button class="primary" onclick="recommend()">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ</button>
        <button onclick="resetForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
      </div>
      <p class="footer">‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡∏™‡πÑ‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡∏°/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠</p>
    </div>

    <div class="card" style="grid-column: span 7;">
      <h2>2) ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏µ (Summary)</h2>
      <div id="output" class="output">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ‚Äù</div>
      <div id="tags" style="margin-top:10px;"></div>
      <div class="divider"></div>
      <div class="row">
        <button class="good" onclick="sendFeedback(true)">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô üëç</button>
        <button class="bad" onclick="sendFeedback(false)">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡πÑ‡∏°‡πà‡∏î‡∏µ üëé</button>
        <div class="right" style="flex:1; align-self:center;"><span class="badge" id="profileScore">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: 0</span></div>
      </div>
      <p class="footer small">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</p>
    </div>

    <div class="card" style="grid-column: span 12;">
      <h2>3) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
      <div class="row">
        <div>
          <button onclick="exportData()">Export ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (JSON)</button>
          <button onclick="importData()">Import ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
          <button onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</button>
        </div>
        <div class="right" style="flex:1">
          <span class="muted small">MVP: rule-based + ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏ñ‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
        </div>
      </div>
      <details style="margin-top:10px;">
        <summary>‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ (Explainability)</summary>
        <div id="why" class="small mono" style="white-space:pre-wrap; margin-top:10px;"></div>
      </details>
    </div>
  </div>
</main>

<script>
// --- Utilities & Storage ---
const KEY = "golf_shot_weights_v1";
const LOGKEY = "golf_shot_logs_v1";

function loadWeights(){
  try { return JSON.parse(localStorage.getItem(KEY)) || {}; } catch(e){ return {}; }
}
function saveWeights(w){ localStorage.setItem(KEY, JSON.stringify(w)); }
function loadLogs(){
  try { return JSON.parse(localStorage.getItem(LOGKEY)) || []; } catch(e){ return []; }
}
function saveLogs(L){ localStorage.setItem(LOGKEY, JSON.stringify(L)); }
function profileScore(){
  const w = loadWeights();
  let s = 0; Object.values(w).forEach(v=> s += v);
  return s;
}
function tagify(text){ return `<span class="tag">${text}</span>`; }

// --- Core Recommendation Engine ---
// Lightweight rule base. Each rule yields one or more "advice tokens".
// Tokens carry weights influenced by feedback.
const baseRules = [
  // Lie-based
  { when: s=> s.lie==="‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå", add:["club_standard","contact_ball_then_turf","normal_trajectory"] },
  { when: s=> s.lie==="‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏ö‡∏≤‡∏á)", add:["take_more_club_small","steepen_slight","firm_grip_lite"] },
  { when: s=> s.lie==="‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏´‡∏ô‡∏≤)", add:["take_more_club","steepen","ball_center_back","reduce_loft","firm_grip","commit_speed"] },
  { when: s=> s.lie==="‡∏ü‡∏£‡∏¥‡∏ô‡∏à‡πå/‡πÄ‡∏≠‡∏û‡∏û‡πÇ‡∏£‡∏ä", add:["putt_or_chip_low","weight_forward","hands_forward","short_back_long_through"] },
  { when: s=> s.lie==="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô", add:["open_face","ball_forward","weight_left","splash_sand","accelerate"] },
  { when: s=> s.lie==="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå", add:["ball_center","pick_ball","less_sand","take_more_club","swing_smooth"] },
  { when: s=> s.lie==="‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü", add:["tee_height_half","launch_high","widen_stance"] },

  // Slope Y (up/downhill)
  { when: s=> s.slopeY==="up_lite", add:["add_club_05","aim_left_right_stable","weight_uphill_foot"] },
  { when: s=> s.slopeY==="up_big", add:["add_club_1","shorter_back","weight_uphill_foot"] },
  { when: s=> s.slopeY==="down_lite", add:["minus_club_05","ball_forward","swing_smooth"] },
  { when: s=> s.slopeY==="down_big", add:["minus_club_1","ball_forward","hold_loft"] },

  // Sidehill X (above/below feet)
  { when: s=> s.slopeX==="above_lite", add:["aim_right","grip_down_05","flatter_plane"] },
  { when: s=> s.slopeX==="above_big", add:["aim_right_more","grip_down_1","flatter_plane"] },
  { when: s=> s.slopeX==="below_lite", add:["aim_left","bend_knees","steeper_plane"] },
  { when: s=> s.slopeX==="below_big", add:["aim_left_more","bend_knees_more","steeper_plane"] },

  // Wind
  { when: s=> s.wind==="head_lite", add:["add_club_05","lower_flight_option","swing_smooth"] },
  { when: s=> s.wind==="head_big", add:["add_club_1","keep_spin_down","ball_back"] },
  { when: s=> s.wind==="tail_lite", add:["minus_club_05","higher_land_soft"] },
  { when: s=> s.wind==="tail_big", add:["minus_club_1","control_spin","land_before_flag"] },
  { when: s=> s.wind==="cross", add:["start_against_wind","allow_drift"] },

  // Ball state
  { when: s=> s.ball==="sitting", add:["ball_forward","shallow_angle","sweep_feel"] },
  { when: s=> s.ball==="down", add:["steepen","hands_forward","commit_speed"] },

  // Turf
  { when: s=> s.turf==="firm", add:["ball_center","shallow_angle","clip_ball"] },
  { when: s=> s.turf==="soft", add:["ball_back","more_steep","make_divot"] },

  // Obstacle
  { when: s=> s.obs==="carry", add:["take_enough_carry","full_commit"] },
  { when: s=> s.obs==="low", add:["knockdown","ball_back","hold_loft"] },
  { when: s=> s.obs==="high", add:["open_face","speed_pop","land_soft"] },

  // Stance
  { when: s=> s.stance==="unstable", add:["shorter_back","more_balance","club_up_if_needed"] },
];

// Token-to-text mapping + default weights for personalization
const tokenMap = {
  // Clubs & distance management
  "club_standard": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
  "take_more_club_small": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏ä‡πà‡∏ô 8 ‚Üí 7)",
  "take_more_club": "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏¢‡∏≤‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ",
  "add_club_05": "‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏¢‡∏∞ +‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏à‡∏≤‡∏Å‡∏™‡∏†‡∏≤‡∏û",
  "add_club_1": "‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏¢‡∏∞ +1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏à‡∏≤‡∏Å‡∏™‡∏†‡∏≤‡∏û",
  "minus_club_05": "‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞ -‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏†‡∏≤‡∏û",
  "minus_club_1": "‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞ -1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏†‡∏≤‡∏û",
  "club_up_if_needed": "‡∏´‡∏≤‡∏Å‡∏Å‡∏•‡∏±‡∏ß‡∏û‡∏•‡∏±‡∏á‡∏ï‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πâ",
  "take_enough_carry": "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ 10%",
  // Ball position / setup
  "ball_center": "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤",
  "ball_center_back": "‡∏•‡∏π‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏ä‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô)",
  "ball_forward": "‡∏•‡∏π‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  "ball_back": "‡∏•‡∏π‡∏Å‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥",
  "widen_stance": "‡∏Å‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏†‡∏≤‡∏û",
  "weight_left": "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 60‚Äì70% ‡πÑ‡∏õ‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô)",
  "weight_uphill_foot": "‡∏ñ‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ (‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏ô‡∏ß‡∏™‡∏ß‡∏¥‡∏á)",
  "weight_forward": "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ 60% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏•‡∏≠‡∏ü‡∏ó‡πå‡∏ï‡∏≠‡∏ô‡∏ä‡∏¥‡∏û",
  "hands_forward": "‡∏°‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡πÉ‡∏ö‡πÑ‡∏°‡πâ",
  // Swing keys
  "contact_ball_then_turf": "‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏î‡∏ô‡∏´‡∏ç‡πâ‡∏≤ (‡πÄ‡∏´‡∏•‡πá‡∏Å)",
  "normal_trajectory": "‡∏™‡∏ß‡∏¥‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏ô‡πâ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠",
  "steepen_slight": "‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏•‡∏á‡πÑ‡∏°‡πâ‡∏ä‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  "steepen": "‡∏•‡∏á‡πÑ‡∏°‡πâ‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏∞‡∏•‡∏∏‡∏´‡∏ç‡πâ‡∏≤‡∏£‡∏±‡∏ü‡∏ó‡πå",
  "more_steep": "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∏‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡∏ü",
  "shallow_angle": "‡∏ó‡∏≥‡∏°‡∏∏‡∏°‡∏ï‡∏∑‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡∏π‡∏Å",
  "pick_ball": "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° '‡∏õ‡∏¥‡πä‡∏Ñ' ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô‡∏ó‡∏£‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î",
  "less_sand": "‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏£‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢",
  "splash_sand": "‡πÄ‡∏ô‡πâ‡∏ô‡∏ü‡∏≤‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏•‡∏π‡∏Å 2‚Äì3 ‡∏ã‡∏°. ‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏¢‡∏û‡∏≤‡∏•‡∏π‡∏Å‡∏≠‡∏≠‡∏Å",
  "accelerate": "‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡∏≠‡∏¢‡πà‡∏≤‡∏ä‡∏∞‡∏á‡∏±‡∏Å",
  "swing_smooth": "‡∏™‡∏ß‡∏¥‡∏á‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏• ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡πÉ‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏ß‡∏¥‡∏á",
  "short_back_long_through": "‡πÅ‡∏ö‡πá‡∏Ñ‡∏™‡∏ß‡∏¥‡∏á‡∏™‡∏±‡πâ‡∏ô ‡∏•‡∏á‡∏¢‡∏≤‡∏ß ‡∏Ñ‡∏∏‡∏°‡∏™‡∏õ‡∏µ‡∏î",
  "shorter_back": "‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ö‡πá‡∏Ñ‡∏™‡∏ß‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ",
  "commit_speed": "‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏™‡∏õ‡∏µ‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏≠‡∏• ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≤‡∏Å‡∏£‡∏±‡∏ü‡∏ó‡πå",
  "flatter_plane": "‡∏¢‡∏∑‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏•‡∏π‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏•‡∏î‡∏°‡∏∏‡∏°‡πÑ‡∏´‡∏•‡πà (‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  "steeper_plane": "‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏•‡∏ô‡∏ä‡∏±‡∏ô (‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  "bend_knees": "‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏ß‡∏¥‡∏á",
  "bend_knees_more": "‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏•",
  "grip_down_05": "‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏õ‡∏•‡∏î‡∏•‡∏á ~0.5 ‡∏ô‡∏¥‡πâ‡∏ß",
  "grip_down_1": "‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏õ‡∏•‡∏î‡∏•‡∏á ~1 ‡∏ô‡∏¥‡πâ‡∏ß",
  "firm_grip_lite": "‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏ö‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏£‡∏±‡∏ü‡∏ó‡πå‡∏ö‡∏≤‡∏á)",
  "firm_grip": "‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏ö‡πÅ‡∏ô‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏£‡∏±‡∏ü‡∏ó‡πå‡∏´‡∏ô‡∏≤)",
  "open_face": "‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ß‡∏î‡∏à‡πå)",
  "speed_pop": "‡πÄ‡∏£‡πà‡∏á‡∏™‡∏õ‡∏µ‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏≠‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏™‡∏π‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
  "hold_loft": "‡∏Ñ‡∏∏‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏™‡∏õ‡∏¥‡∏ô/‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥",
  "keep_spin_down": "‡∏Ñ‡∏∏‡∏°‡∏™‡∏õ‡∏¥‡∏ô: ‡∏™‡∏ß‡∏¥‡∏á‡∏™‡∏±‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á/‡∏ô‡∏∏‡πà‡∏°‡∏°‡∏∑‡∏≠",
  "control_spin": "‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏õ‡∏¥‡∏ô‡∏û‡∏∏‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏°‡∏ï‡∏≤‡∏° ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏ô‡∏î‡∏¥‡πâ‡∏á",
  "start_against_wind": "‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡∏®‡∏•‡∏°",
  "allow_drift": "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡∏•‡∏π‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô",
  "knockdown": "‡∏ä‡πá‡∏≠‡∏ï‡∏Ñ‡πá‡∏≠‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå: ‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤/‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á/‡∏ü‡∏•‡∏ß‡πå‡∏ï‡πà‡∏≥",
  "higher_land_soft": "‡πÄ‡∏õ‡∏¥‡∏î‡∏ß‡∏¥‡∏ñ‡∏µ‡πÉ‡∏´‡πâ‡∏ï‡∏Å‡∏ô‡∏∏‡πà‡∏°‡∏•‡∏á",
  "launch_high": "‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏™‡∏π‡∏á‡∏û‡∏≠‡∏î‡∏µ ‡∏™‡∏ß‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏∏‡∏°‡πÄ‡∏´‡∏¥‡∏ô",
  "tee_height_half": "‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏±‡∏ß‡πÑ‡∏°‡πâ",
  "putt_or_chip_low": "‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏û‡∏±‡∏ï‡∏ï‡πå/‡∏ä‡∏¥‡∏û‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥ ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î",
  "clip_ball": "‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° '‡∏Ñ‡∏•‡∏¥‡∏õ' ‡∏•‡∏π‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á",
  "make_divot": "‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏î‡∏¥‡∏ù‡∏±‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¥‡∏°‡πÅ‡∏û‡∏Ñ‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ‡∏õ‡∏¥‡∏î‡∏ô‡∏¥‡∏î‡πÜ",
  "sweep_feel": "‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ç‡πâ‡∏≤‡∏™‡∏π‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏∏‡πà‡∏°",
  // Trajectory & landing
  "lower_flight_option": "‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô‡∏•‡∏°",
  "land_soft": "‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ï‡∏Å‡∏ô‡∏∏‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏≠‡∏ü‡∏ó‡πå/‡∏™‡∏õ‡∏¥‡∏ô",
  // Pin strategy
  "aim_left": "‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  "aim_left_more": "‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  "aim_right": "‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  "aim_right_more": "‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  "aim_left_right_stable": "‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÅ‡∏ô‡∏ß‡∏™‡∏ß‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏•‡∏≤‡∏î"
};

// Default weights
function defaultWeight(token){
  const base = {
    "club_standard": 1, "take_more_club_small": 2, "take_more_club": 2,
    "add_club_05": 2, "add_club_1": 3, "minus_club_05": 2, "minus_club_1": 3,
    "ball_center": 1, "ball_center_back": 2, "ball_forward": 1, "ball_back": 2,
    "widen_stance": 1, "weight_left": 2, "weight_uphill_foot": 2, "weight_forward": 2, "hands_forward": 2,
    "contact_ball_then_turf": 2, "normal_trajectory": 1, "steepen_slight": 2, "steepen": 3, "more_steep":2,
    "shallow_angle": 2, "pick_ball": 2, "less_sand": 2, "splash_sand": 3, "accelerate": 2, "swing_smooth": 1,
    "short_back_long_through": 2, "shorter_back": 2, "commit_speed": 3, "flatter_plane": 2, "steeper_plane": 2,
    "bend_knees": 1, "bend_knees_more": 2, "grip_down_05": 1, "grip_down_1": 2, "firm_grip_lite": 1, "firm_grip": 2,
    "open_face": 2, "speed_pop": 2, "hold_loft": 2, "keep_spin_down": 2, "control_spin": 2, "start_against_wind": 2,
    "allow_drift": 1, "knockdown": 3, "higher_land_soft": 2, "launch_high": 2, "tee_height_half": 1, "putt_or_chip_low": 2,
    "clip_ball": 2, "make_divot": 2, "sweep_feel": 1, "lower_flight_option":2, "land_soft":2,
    "aim_left":1, "aim_left_more":1, "aim_right":1, "aim_right_more":1, "aim_left_right_stable":1,
    "take_enough_carry":3, "full_commit":2
  };
  return base[token] || 1;
}

function currentState(){
  return {
    lie: document.getElementById('lie').value,
    dist: +document.getElementById('dist').value,
    slopeY: document.getElementById('slopeY').value,
    slopeX: document.getElementById('slopeX').value,
    wind: document.getElementById('wind').value,
    ball: document.getElementById('ball').value,
    turf: document.getElementById('turf').value,
    obs: document.getElementById('obs').value,
    stance: document.getElementById('stance').value,
    pin: document.getElementById('pin').value,
    time: new Date().toISOString()
  };
}

function ruleTokens(state){
  let tokens = [];
  let why = [];
  baseRules.forEach(r=> {
    try {
      if (r.when(state)){
        tokens = tokens.concat(r.add);
        why.push({trigger: r.when.toString().slice(0,80)+"...", add: r.add});
      }
    } catch(e){ /* ignore */}
  });
  // distance-specific heuristics
  if (state.dist <= 40 && state.lie!=="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå"){
    tokens.push("short_back_long_through","weight_forward","hands_forward");
  } else if (state.dist >= 170 && state.lie!=="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô"){
    tokens.push("swing_smooth","club_up_if_needed");
  }
  return {tokens:[...new Set(tokens)], why};
}

// Combine tokens into grouped recommendations
function toAdvice(tokens, weights){
  const txt = (t)=> tokenMap[t] || t;
  // Score tokens using default + personalized weights
  const final = tokens.map(t=> {
    const base = defaultWeight(t);
    const w = (weights && Number.isFinite(weights[t])) ? weights[t] : 0;
    return { token:t, score: base + w, text: txt(t) };
  }).sort((a,b)=> b.score - a.score);

  // Group by category (rough heuristics via token prefixes)
  const sections = [
    {name:"‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πâ/‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞", filter:["club","add_club","minus_club","take_enough_carry","carry","knockdown","lower_flight_option","higher_land_soft","keep_spin_down","control_spin","land_soft","start_against_wind","allow_drift","launch_high","tee_height_half","club_up_if_needed"]},
    {name:"‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏à‡∏î‡∏•‡∏π‡∏Å/‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏±‡∏û", filter:["ball_","weight_","hands_forward","widen_stance","grip_down","bend_knees"]},
    {name:"‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏ß‡∏¥‡∏á/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞", filter:["contact_","normal_","steepen","shallow","pick_ball","less_sand","splash_sand","accelerate","swing_smooth","short_back","shorter_back","commit_speed","flatter_plane","steeper_plane","hold_loft","open_face","speed_pop","clip_ball","make_divot","sweep_feel"]},
    {name:"‡∏Å‡∏•‡∏¢‡∏∏‡∏ó‡∏ò‡πå‡πÄ‡∏™‡πâ‡∏ô/‡∏ó‡∏¥‡∏®", filter:["aim_"]}
  ];

  function inFilter(token, arr){
    return arr.some(prefix=> token.startsWith(prefix));
  }

  const lines = [];
  sections.forEach(sec=> {
    const items = final.filter(x=> inFilter(x.token, sec.filter)).slice(0,6);
    if (items.length){
      lines.push(`‚Ä¢ <span class="small" style="color:#93c5fd">${sec.name}</span>`);
      lines.push("<ul>");
      items.forEach(it=> lines.push(`<li>${it.text}</li>`));
      lines.push("</ul>");
    }
  });

  // Fallback show all if empty
  if (!lines.length){
    lines.push("<ul>");
    final.slice(0,8).forEach(it=> lines.push(`<li>${it.text}</li>`));
    lines.push("</ul>");
  }

  // Collect top tags
  const tags = final.slice(0,6).map(it=> tagify(it.text));
  return { html: lines.join("\n"), tags: tags.join(" ") };
}

// Input ‚Üí Recommend
let lastState = null;
let lastTokens = [];
function recommend(){
  const s = currentState();
  const {tokens, why} = ruleTokens(s);
  lastState = s; lastTokens = tokens;
  const weights = loadWeights();
  const advice = toAdvice(tokens, weights);
  document.getElementById('output').innerHTML = advice.html;
  document.getElementById('tags').innerHTML = advice.tags;
  document.getElementById('why').textContent = JSON.stringify({state:s, tokens, rules_fired:why}, null, 2);
  document.getElementById('profileScore').textContent = "‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: " + profileScore();
  addLog({type:"recommend", state:s, tokens});
  window.scrollTo({top:0, behavior:"smooth"});
}

// Feedback
function sendFeedback(isGood){
  if (!lastState){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ' ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞"); return; }
  const w = loadWeights();
  const delta = isGood ? +1 : -1;
  lastTokens.forEach(t=> { w[t] = (w[t] || 0) + delta; });
  saveWeights(w);
  addLog({type: isGood ? "good" : "bad", state:lastState, tokens:lastTokens, delta});
  document.getElementById('profileScore').textContent = "‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: " + profileScore();
  // Recompute to show new order
  const advice = toAdvice(lastTokens, w);
  document.getElementById('output').innerHTML = advice.html;
  document.getElementById('tags').innerHTML = advice.tags;
}

// Logs / Export
function addLog(entry){
  const L = loadLogs();
  L.push({...entry, ts: new Date().toISOString()});
  saveLogs(L);
}
function exportData(){
  const data = {
    version: "1.0",
    weights: loadWeights(),
    logs: loadLogs()
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = "golf_shot_profile.json"; a.click();
  URL.revokeObjectURL(url);
}
function importData(){
  const inp = document.createElement('input');
  inp.type = "file"; inp.accept = "application/json";
  inp.onchange = (e)=> {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=> {
      try {
        const data = JSON.parse(reader.result);
        if (data.weights) saveWeights(data.weights);
        if (data.logs) saveLogs(data.logs);
        alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        document.getElementById('profileScore').textContent = "‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: " + profileScore();
      } catch(err){ alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
    };
    reader.readAsText(file);
  };
  inp.click();
}
function clearData(){
  if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
    localStorage.removeItem(KEY);
    localStorage.removeItem(LOGKEY);
    document.getElementById('profileScore').textContent = "‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: 0";
    alert("‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß");
  }
}
function resetForm(){
  document.getElementById('lie').selectedIndex = 0;
  document.getElementById('dist').value = 120;
  document.getElementById('slopeY').value = "flat";
  document.getElementById('slopeX').value = "level";
  document.getElementById('wind').value = "calm";
  document.getElementById('ball').value = "normal";
  document.getElementById('turf').value = "normal";
  document.getElementById('obs').value = "none";
  document.getElementById('stance').value = "stable";
  document.getElementById('pin').value = "center";
  document.getElementById('output').textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ‚Äù";
  document.getElementById('tags').innerHTML = "";
  document.getElementById('why').textContent = "";
}
document.addEventListener('DOMContentLoaded', ()=> {
  document.getElementById('profileScore').textContent = "‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: " + profileScore();
});
</script>
</body>
</html>

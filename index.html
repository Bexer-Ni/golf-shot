<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Shot Decision Assistant (‡∏Å‡∏≠‡∏•‡πå‡∏ü) ‚Äî Pro MVP</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8; --good:#34d399; --bad:#f87171; }
  * { box-sizing:border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans Thai", sans-serif; background: linear-gradient(180deg,#0b1220,#0f172a 60%); color:var(--text); }
  header { padding: 20px 16px 8px; position: sticky; top:0; background: rgba(15,23,42,0.85); backdrop-filter: blur(6px); border-bottom:1px solid #1f2937; z-index:10; }
  header h1{ margin:0; font-size:20px; }
  header p{ margin:6px 0 0; color:var(--muted); font-size:13px; }
  main{ padding:16px; max-width:980px; margin:0 auto; }
  .card{ background: linear-gradient(180deg,#0b1020,#0d1323); border:1px solid #1f2937; border-radius:12px; padding:14px; box-shadow:0 8px 20px rgba(0,0,0,.25); margin-bottom:12px; }
  .card h2{ font-size:16px; margin:0 0 8px; }
  label{ display:block; font-size:13px; color:#cbd5e1; margin:8px 0 4px; }
  select,input[type="number"],input[type="text"]{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:var(--text); }
  .row{ display:flex; gap:10px; }
  .row > *{ flex:1; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  @media (max-width:820px){ .grid3{ grid-template-columns:1fr 1fr; } }
  @media (max-width:620px){ .grid2,.grid3{ grid-template-columns:1fr; } }
  button{ cursor:pointer; border:1px solid #334155; background:#0b1220; color:var(--text); padding:10px 12px; border-radius:10px; font-weight:600; }
  button.primary{ background: linear-gradient(180deg,#0891b2,#0284c7); border:none; }
  button.good{ background: linear-gradient(180deg,#10b981,#059669); border:none; }
  button.bad{ background: linear-gradient(180deg,#ef4444,#dc2626); border:none; }
  .divider{ height:1px; background:#1f2937; margin:10px 0; }
  .small{ font-size:12px; color:#cbd5e1; }
  .output{ font-size:14px; line-height:1.55; }
  ul{ margin:8px 0 0 18px; }
  .tag{ font-size:11px; color:var(--muted); display:inline-block; padding:2px 8px; border:1px solid #334155; border-radius:999px; margin-right:6px; }
  .right{ text-align:right; }
  .muted{ color:var(--muted); }
  details{ border:1px solid #334155; border-radius:10px; padding:10px 12px; background:#0b1220; }
  summary{ cursor:pointer; font-weight:700; }
  .badge{ background:#0b1220; border:1px solid #334155; font-size:11px; padding:4px 8px; border-radius:999px; display:inline-block; margin-right:6px; color:#cbd5e1; }
  .subtle{ opacity:.9 }
</style>
</head>
<body>
<header>
  <h1>Shot Decision Assistant ‚Ä¢ Pro MVP (‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á)</h1>
  <p>‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏£‡∏ö‡∏Å‡∏ß‡πà‡∏≤ ‚Ä¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å Feedback ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
</header>

<main>
  <!-- Inputs TOP -->
  <div class="card">
    <h2>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏ä‡πá‡∏≠‡∏ï (Conditions)</h2>
    <div class="grid3">
      <div>
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ä‡πá‡∏≠‡∏ï</label>
        <select id="shotType">
          <option value="approach">Approach</option>
          <option value="layup">Layup</option>
          <option value="recovery">Recovery / Punch</option>
          <option value="tee">Tee Shot</option>
          <option value="short">Short Game</option>
        </select>
      </div>
      <div>
        <label>Lie</label>
        <select id="lie">
          <option>‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå</option>
          <option>‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏ö‡∏≤‡∏á)</option>
          <option>‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏´‡∏ô‡∏≤)</option>
          <option>‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option>
          <option>‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå</option>
          <option>‡∏ü‡∏£‡∏¥‡∏ô‡∏à‡πå/‡πÄ‡∏≠‡∏û‡∏û‡πÇ‡∏£‡∏ä</option>
          <option>‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü</option>
        </select>
      </div>
      <div>
        <label>‡∏£‡∏∞‡∏¢‡∏∞‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤ (‡πÄ‡∏°‡∏ï‡∏£)</label>
        <input id="dist" type="number" min="5" max="260" step="1" value="120">
      </div>
      <div>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ô ‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á‡πÄ‡∏ô‡∏¥‡∏ô</label>
        <select id="slopeY">
          <option value="flat">‡∏û‡∏∑‡πâ‡∏ô‡∏£‡∏≤‡∏ö</option>
          <option value="up_lite">‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
          <option value="up_big">‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ô‡∏¥‡∏ô‡∏°‡∏≤‡∏Å</option>
          <option value="down_lite">‡∏•‡∏á‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
          <option value="down_big">‡∏•‡∏á‡πÄ‡∏ô‡∏¥‡∏ô‡∏°‡∏≤‡∏Å</option>
        </select>
      </div>
      <div>
        <label>‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á/‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤</label>
        <select id="slopeX">
          <option value="level">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏ó‡πâ‡∏≤</option>
          <option value="above_lite">‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
          <option value="above_big">‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤‡∏°‡∏≤‡∏Å</option>
          <option value="below_lite">‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
          <option value="below_big">‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤‡∏°‡∏≤‡∏Å</option>
        </select>
      </div>
      <div>
        <label>‡∏•‡∏°</label>
        <select id="wind">
          <option value="calm">‡∏•‡∏°‡∏™‡∏á‡∏ö</option>
          <option value="head_lite">‡∏•‡∏°‡∏ï‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
          <option value="head_big">‡∏•‡∏°‡∏ï‡πâ‡∏≤‡∏ô‡πÅ‡∏£‡∏á</option>
          <option value="tail_lite">‡∏•‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</option>
          <option value="tail_big">‡∏•‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏£‡∏á</option>
          <option value="cross_l2r">‡∏•‡∏°‡∏Ç‡∏ß‡∏≤‡∏á ‡∏ã‡πâ‡∏≤‡∏¢‚Üí‡∏Ç‡∏ß‡∏≤</option>
          <option value="cross_r2l">‡∏•‡∏°‡∏Ç‡∏ß‡∏≤‡∏á ‡∏Ç‡∏ß‡∏≤‚Üí‡∏ã‡πâ‡∏≤‡∏¢</option>
        </select>
      </div>
      <div>
        <label>‡∏™‡∏†‡∏≤‡∏û‡∏•‡∏π‡∏Å</label>
        <select id="ball">
          <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="sitting">‡∏•‡∏≠‡∏¢‡∏ö‡∏ô‡∏´‡∏ç‡πâ‡∏≤</option>
          <option value="down">‡∏à‡∏°/‡∏ù‡∏±‡∏á</option>
        </select>
      </div>
      <div>
        <label>‡∏û‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô</label>
        <select id="turf">
          <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="firm">‡πÅ‡∏Ç‡πá‡∏á</option>
          <option value="soft">‡∏ô‡∏∏‡πà‡∏°/‡∏ä‡∏∑‡πâ‡∏ô</option>
        </select>
      </div>
      <div>
        <label>‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</label>
        <select id="obs">
          <option value="none">‡πÑ‡∏°‡πà‡∏°‡∏µ</option>
          <option value="carry">‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</option>
          <option value="low">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏°‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥</option>
          <option value="high">‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏¥‡∏û/‡∏¢‡∏Å‡∏™‡∏π‡∏á</option>
        </select>
      </div>
      <div>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô</label>
        <select id="stance">
          <option value="stable">‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á</option>
          <option value="unstable">‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á</option>
        </select>
      </div>
      <div>
        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ò‡∏á</label>
        <select id="pin">
          <option value="center">‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option>
          <option value="front">‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏£‡∏µ‡∏ô</option>
          <option value="back">‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏µ‡∏ô</option>
          <option value="left">‡∏ã‡πâ‡∏≤‡∏¢</option>
          <option value="right">‡∏Ç‡∏ß‡∏≤</option>
        </select>
      </div>
      <div>
        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏£‡∏µ‡∏ô</label>
        <select id="green">
          <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option>
          <option value="slow">‡∏ä‡πâ‡∏≤/‡∏ô‡∏∏‡πà‡∏°</option>
          <option value="fast">‡πÑ‡∏ß/‡πÅ‡∏Ç‡πá‡∏á</option>
        </select>
      </div>
      <div>
        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ã‡πâ‡∏≤‡∏¢, ‡∏´‡∏•‡∏µ‡∏Å‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå)</label>
        <input id="notes" type="text" placeholder="‡πÉ‡∏™‡πà‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏•‡∏∏‡∏°/‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á">
      </div>
    </div>
    <div class="divider"></div>
    <div class="row">
      <button class="primary" onclick="recommend()">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ</button>
      <button onclick="resetForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>
    <p class="small muted">MVP: rule-based + ‡πÅ‡∏Å‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á (‡πÑ‡∏°‡πâ/‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏π‡∏Å/‡∏ß‡∏¥‡∏ñ‡∏µ) + ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°</p>
  </div>

  <!-- Advice UNDER -->
  <div class="card">
    <h2>2) ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏µ (Summary)</h2>
    <div id="output" class="output">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ‚Äù</div>
    <div id="tags" style="margin-top:10px;"></div>
    <div class="divider"></div>
    <div class="row">
      <button class="good" onclick="sendFeedback(true)">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô üëç</button>
      <button class="bad" onclick="sendFeedback(false)">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡πÑ‡∏°‡πà‡∏î‡∏µ üëé</button>
      <div class="right" style="flex:1; align-self:center;"><span class="badge" id="profileScore">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: 0</span></div>
    </div>
    <p class="small muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</p>
  </div>

  <div class="card">
    <h2>3) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏µ (‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ)</h2>
    <div class="grid3">
      <div>
        <label>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏Å</label>
        <select id="res_main">
          <option value="hit">‡πÇ‡∏î‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô</option>
          <option value="short">‡∏™‡∏±‡πâ‡∏ô</option>
          <option value="long">‡∏¢‡∏≤‡∏ß</option>
          <option value="left">‡∏´‡∏•‡∏∏‡∏î‡∏ã‡πâ‡∏≤‡∏¢</option>
          <option value="right">‡∏´‡∏•‡∏∏‡∏î‡∏Ç‡∏ß‡∏≤</option>
          <option value="fat">Fat</option>
          <option value="thin">Thin</option>
          <option value="bunker">‡∏•‡∏á‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå</option>
        </select>
      </div>
      <div>
        <label>‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ö‡∏≠‡∏•</label>
        <select id="ball_shape">
          <option value="straight">‡∏ï‡∏£‡∏á</option>
          <option value="draw">Draw</option>
          <option value="fade">Fade</option>
          <option value="hook">Hook</option>
          <option value="slice">Slice</option>
        </select>
      </div>
      <div>
        <label>‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏¢‡∏∞ (‡πÄ‡∏°‡∏ï‡∏£)</label>
        <input id="miss_m" type="number" step="1" value="0">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button onclick="saveResult()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
      <div class="right" style="flex:1"><span class="small subtle" id="logCount">logs: 0</span></div>
    </div>
  </div>

  <div class="card">
    <h2>4) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ & ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</h2>
    <div class="row">
      <div>
        <button onclick="exportData()">Export ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (JSON)</button>
        <button onclick="importData()">Import ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
        <button onclick="clearData()">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</button>
      </div>
      <div class="right" style="flex:1">
        <span class="muted small">Explainability</span>
      </div>
    </div>
    <details style="margin-top:10px;">
      <summary>‡∏î‡∏π‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏Å‡∏é‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ</summary>
      <div id="why" class="small" style="white-space:pre-wrap; margin-top:10px;"></div>
    </details>
  </div>
</main>

<script>
// --- Storage ---
const KEY="golf_shot_weights_v2";
const LOGKEY="golf_shot_logs_v2";
function loadWeights(){ try{return JSON.parse(localStorage.getItem(KEY))||{}}catch(e){return{}} }
function saveWeights(w){ localStorage.setItem(KEY, JSON.stringify(w)); }
function loadLogs(){ try{return JSON.parse(localStorage.getItem(LOGKEY))||[]}catch(e){return[]} }
function saveLogs(L){ localStorage.setItem(LOGKEY, JSON.stringify(L)); }
function profileScore(){ const w=loadWeights(); return Object.values(w).reduce((a,b)=>a+b,0); }
const tag = t=> `<span class="tag">${t}</span>`;

// --- Rule base (‡∏Ç‡∏¢‡∏≤‡∏¢) ---
const baseRules=[
  // Lie
  {when:s=>s.lie==="‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå", add:["club_standard","contact_ball_then_turf","normal_trajectory"]},
  {when:s=>s.lie==="‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏ö‡∏≤‡∏á)", add:["club_up_0_5","steepen_slight","firm_grip_lite"]},
  {when:s=>s.lie==="‡∏£‡∏±‡∏ü‡∏ó‡πå (‡∏´‡∏ô‡∏≤)", add:["club_up_1","steepen","ball_center_back","reduce_loft_hint","firm_grip","commit_speed"]},
  {when:s=>s.lie==="‡∏ü‡∏£‡∏¥‡∏ô‡∏à‡πå/‡πÄ‡∏≠‡∏û‡∏û‡πÇ‡∏£‡∏ä", add:["consider_putt_or_low_chip","weight_forward","hands_forward","short_back_long_through"]},
  {when:s=>s.lie==="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô", add:["open_face","ball_forward","weight_left","splash_sand","accelerate","traj_high_1"]},
  {when:s=>s.lie==="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå", add:["ball_center","pick_ball","less_sand","club_up_1","swing_smooth"]},
  {when:s=>s.lie==="‡∏ó‡∏µ‡∏≠‡∏≠‡∏ü", add:["tee_height_half","launch_high","widen_stance","traj_high_1"]},

  // Shot type tweaks
  {when:s=>s.shotType==="recovery", add:["traj_low_2","ball_back","knockdown","start_against_wind"]},
  {when:s=>s.shotType==="short", add:["weight_forward","hands_forward","short_back_long_through"]},

  // Slope Y
  {when:s=>s.slopeY==="up_lite", add:["club_up_0_5","aim_balance","weight_uphill_foot"]},
  {when:s=>s.slopeY==="up_big", add:["club_up_1","shorter_back","weight_uphill_foot"]},
  {when:s=>s.slopeY==="down_lite", add:["club_down_0_5","ball_forward","swing_smooth","traj_high_1"]},
  {when:s=>s.slopeY==="down_big", add:["club_down_1","ball_forward","hold_loft","traj_high_1"]},

  // Sidehill
  {when:s=>s.slopeX==="above_lite", add:["aim_right","grip_down_0_5","flatter_plane"]},
  {when:s=>s.slopeX==="above_big", add:["aim_right_more","grip_down_1","flatter_plane"]},
  {when:s=>s.slopeX==="below_lite", add:["aim_left","bend_knees","steeper_plane"]},
  {when:s=>s.slopeX==="below_big", add:["aim_left_more","bend_knees_more","steeper_plane"]},

  // Wind
  {when:s=>s.wind==="head_lite", add:["club_up_0_5","traj_low_1","swing_smooth"]},
  {when:s=>s.wind==="head_big", add:["club_up_1","keep_spin_down","ball_back","traj_low_2"]},
  {when:s=>s.wind==="tail_lite", add:["club_down_0_5","traj_high_1"]},
  {when:s=>s.wind==="tail_big", add:["club_down_1","control_spin","land_before_flag","traj_high_2"]},
  {when:s=>s.wind==="cross_l2r", add:["start_against_wind_l2r","allow_drift"]},
  {when:s=>s.wind==="cross_r2l", add:["start_against_wind_r2l","allow_drift"]},

  // Ball state
  {when:s=>s.ball==="sitting", add:["ball_forward","shallow_angle","sweep_feel","traj_high_1"]},
  {when:s=>s.ball==="down", add:["steepen","hands_forward","commit_speed","ball_back","traj_low_1"]},

  // Turf
  {when:s=>s.turf==="firm", add:["ball_center","shallow_angle","clip_ball"]},
  {when:s=>s.turf==="soft", add:["ball_back","more_steep","make_divot_en"]},

  // Obstacle
  {when:s=>s.obs==="carry", add:["take_enough_carry","full_commit"]},
  {when:s=>s.obs==="low", add:["knockdown","ball_back","hold_loft","traj_low_2"]},
  {when:s=>s.obs==="high", add:["open_face","speed_pop","land_soft","traj_high_2"]},

  // Stance
  {when:s=>s.stance==="unstable", add:["shorter_back","more_balance","club_up_0_5"]},

  // Green speed
  {when:s=>s.green==="fast", add:["land_before_flag","traj_high_1"]},
  {when:s=>s.green==="slow", add:["aim_center_bias","traj_low_1"]},
];

const tokenMap={
  // Club / distance
  "club_standard":"‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
  "club_up_0_5":"+0.5 ‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô)",
  "club_up_1":"+1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô)",
  "club_down_0_5":"-0.5 ‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏Å‡∏•)",
  "club_down_1":"-1 ‡πÄ‡∏ö‡∏≠‡∏£‡πå (‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÑ‡∏Å‡∏•)",
  "take_enough_carry":"‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ 10%",
  "full_commit":"‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏™‡∏õ‡∏µ‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå",
  "club_up_if_needed":"‡∏ñ‡πâ‡∏≤‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏û‡∏•‡∏±‡∏á‡∏ï‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÑ‡∏°‡πâ",

  // Setup
  "ball_center":"‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤",
  "ball_center_back":"‡∏•‡∏π‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏ä‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô)",
  "ball_forward":"‡∏•‡∏π‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  "ball_back":"‡∏•‡∏π‡∏Å‡πÑ‡∏õ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥",
  "widen_stance":"‡∏Å‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏†‡∏≤‡∏û",
  "weight_left":"‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å 60‚Äì70% ‡πÑ‡∏õ‡πÄ‡∏ó‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢ (‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô)",
  "weight_uphill_foot":"‡∏ñ‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤",
  "weight_forward":"‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ 60% ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏•‡∏≠‡∏ü‡∏ó‡πå‡∏ï‡∏≠‡∏ô‡∏ä‡∏¥‡∏û",
  "hands_forward":"‡∏°‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡πÉ‡∏ö‡πÑ‡∏°‡πâ",
  "grip_down_0_5":"‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏õ‡∏•‡∏î‡∏•‡∏á ~0.5 ‡∏ô‡∏¥‡πâ‡∏ß",
  "grip_down_1":"‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏õ‡∏•‡∏î‡∏•‡∏á ~1 ‡∏ô‡∏¥‡πâ‡∏ß",

  // Swing
  "contact_ball_then_turf":"‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏î‡∏ô‡∏´‡∏ç‡πâ‡∏≤ (‡πÄ‡∏´‡∏•‡πá‡∏Å)",
  "normal_trajectory":"‡∏™‡∏ß‡∏¥‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÄ‡∏ô‡πâ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠",
  "steepen_slight":"‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏•‡∏á‡πÑ‡∏°‡πâ‡∏ä‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  "steepen":"‡∏•‡∏á‡πÑ‡∏°‡πâ‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏∞‡∏•‡∏∏‡∏´‡∏ç‡πâ‡∏≤‡∏£‡∏±‡∏ü‡∏ó‡πå",
  "more_steep":"‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏∏‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î fat",
  "shallow_angle":"‡∏ó‡∏≥‡∏°‡∏∏‡∏°‡∏ï‡∏∑‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡∏π‡∏Å",
  "pick_ball":"‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° 'pick' ‡∏•‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô‡∏ó‡∏£‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢",
  "less_sand":"‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏£‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢",
  "splash_sand":"‡πÄ‡∏ô‡πâ‡∏ô‡∏ü‡∏≤‡∏î‡∏ó‡∏£‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏•‡∏π‡∏Å 2‚Äì3 ‡∏ã‡∏°. ‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏¢‡∏û‡∏≤‡∏•‡∏π‡∏Å‡∏≠‡∏≠‡∏Å",
  "accelerate":"‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡∏≠‡∏¢‡πà‡∏≤‡∏ä‡∏∞‡∏á‡∏±‡∏Å",
  "swing_smooth":"‡∏™‡∏ß‡∏¥‡∏á‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏• ‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡πÉ‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏ß‡∏¥‡∏á",
  "short_back_long_through":"‡πÅ‡∏ö‡πá‡∏Ñ‡∏™‡∏ß‡∏¥‡∏á‡∏™‡∏±‡πâ‡∏ô ‡∏•‡∏á‡∏¢‡∏≤‡∏ß ‡∏Ñ‡∏∏‡∏°‡∏™‡∏õ‡∏µ‡∏î",
  "shorter_back":"‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ö‡πá‡∏Ñ‡∏™‡∏ß‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ",
  "commit_speed":"‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏™‡∏õ‡∏µ‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏≠‡∏• ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≤‡∏Å‡∏£‡∏±‡∏ü‡∏ó‡πå",
  "flatter_plane":"‡∏¢‡∏∑‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏•‡∏π‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  "steeper_plane":"‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏•‡∏ô‡∏ä‡∏±‡∏ô (‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  "bend_knees":"‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏ß‡∏¥‡∏á",
  "bend_knees_more":"‡∏á‡∏≠‡πÄ‡∏Ç‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏•",
  "firm_grip_lite":"‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏ö‡πÅ‡∏ô‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  "firm_grip":"‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏ö‡πÅ‡∏ô‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥",
  "open_face":"‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏±‡∏ö‡∏Å‡∏£‡∏¥‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ß‡∏î‡∏à‡πå)",
  "speed_pop":"‡πÄ‡∏£‡πà‡∏á‡∏™‡∏õ‡∏µ‡∏î‡∏ú‡πà‡∏≤‡∏ô‡∏ö‡∏≠‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡∏™‡∏π‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
  "hold_loft":"‡∏Ñ‡∏∏‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏™‡∏õ‡∏¥‡∏ô/‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥",
  "keep_spin_down":"‡∏Ñ‡∏∏‡∏°‡∏™‡∏õ‡∏¥‡∏ô: ‡∏™‡∏ß‡∏¥‡∏á‡∏™‡∏±‡πâ‡∏ô/‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á/‡∏ô‡∏∏‡πà‡∏°‡∏°‡∏∑‡∏≠",
  "control_spin":"‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏™‡∏õ‡∏¥‡∏ô‡∏û‡∏∏‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏°‡∏ï‡∏≤‡∏° ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏ô‡∏î‡∏¥‡πâ‡∏á",
  "clip_ball":"‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° 'clip' ‡∏•‡∏π‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á",
  "make_divot_en":"Make a divot (‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏≠‡∏¥‡∏°‡πÅ‡∏û‡∏Ñ)",
  "sweep_feel":"‡∏Å‡∏ß‡∏≤‡∏î‡∏•‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ç‡πâ‡∏≤‡∏™‡∏π‡∏á‡πÅ‡∏ö‡∏ö‡∏ô‡∏∏‡πà‡∏°",

  // Strategy / Aim / Trajectory
  "start_against_wind":"‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ó‡∏¥‡∏®‡∏•‡∏°",
  "start_against_wind_l2r":"‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏•‡∏° (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡πâ‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤)",
  "start_against_wind_r2l":"‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏•‡∏° (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡∏ß‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡πÑ‡∏õ‡∏ã‡πâ‡∏≤‡∏¢)",
  "allow_drift":"‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏•‡∏°‡∏û‡∏≤‡∏•‡∏π‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô",
  "aim_left":"‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  "aim_left_more":"‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  "aim_right":"‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡∏•‡∏π‡∏Å‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ó‡πâ‡∏≤)",
  "aim_right_more":"‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  "aim_balance":"‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏°‡∏î‡∏∏‡∏•‡πÅ‡∏ô‡∏ß‡∏™‡∏ß‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏•‡∏≤‡∏î",
  "traj_low_1":"(‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)",
  "traj_low_2":"(‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)",
  "traj_high_1":"(‡∏ß‡∏¥‡∏ñ‡∏µ‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)",
  "traj_high_2":"(‡∏ß‡∏¥‡∏ñ‡∏µ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)",
  "land_before_flag":"‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ï‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ò‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢",
  "land_soft":"‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ï‡∏Å‡∏ô‡∏∏‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏≠‡∏ü‡∏ó‡πå/‡∏™‡∏õ‡∏¥‡∏ô",
  "knockdown":"Knockdown: ‡∏•‡∏π‡∏Å‡∏´‡∏•‡∏±‡∏á/‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤/‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥",
  "consider_putt_or_low_chip":"‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏û‡∏±‡∏ï‡∏ï‡πå/‡∏ä‡∏¥‡∏û‡∏•‡∏π‡∏Å‡∏ï‡πà‡∏≥ ‡∏ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î",
  "reduce_loft_hint":"‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏•‡∏≠‡∏ü‡∏ó‡πå‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏±‡∏ü‡∏ó‡πå‡∏´‡∏ô‡∏≤",

  // Bias / safety
  "aim_center_bias":"‡πÄ‡∏•‡πá‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á",
};

function defaultWeight(token){
  const base={
    "club_standard":1, "take_enough_carry":3, "full_commit":2,
    "ball_center":1, "ball_center_back":2, "ball_forward":1, "ball_back":2,
    "widen_stance":1, "weight_left":2, "weight_uphill_foot":2, "weight_forward":2, "hands_forward":2,
    "contact_ball_then_turf":2, "normal_trajectory":1, "steepen_slight":2, "steepen":3, "more_steep":2,
    "shallow_angle":2, "pick_ball":2, "less_sand":2, "splash_sand":3, "accelerate":2, "swing_smooth":1,
    "short_back_long_through":2, "shorter_back":2, "commit_speed":3, "flatter_plane":2, "steeper_plane":2,
    "bend_knees":1, "bend_knees_more":2, "grip_down_0_5":1, "grip_down_1":2, "firm_grip_lite":1, "firm_grip":2,
    "open_face":2, "speed_pop":2, "hold_loft":2, "keep_spin_down":2, "control_spin":2, "start_against_wind":2,
    "start_against_wind_l2r":2, "start_against_wind_r2l":2, "allow_drift":1, "clip_ball":2, "make_divot_en":2,
    "consider_putt_or_low_chip":2, "reduce_loft_hint":1, "aim_left":1, "aim_left_more":1, "aim_right":1, "aim_right_more":1, "aim_balance":1,
    "knockdown":3, "land_before_flag":2, "land_soft":2, "aim_center_bias":1
  }; return base[token]||1;
}

function currentState(){
  return {
    shotType:document.getElementById('shotType').value,
    lie:document.getElementById('lie').value,
    dist:+document.getElementById('dist').value,
    slopeY:document.getElementById('slopeY').value,
    slopeX:document.getElementById('slopeX').value,
    wind:document.getElementById('wind').value,
    ball:document.getElementById('ball').value,
    turf:document.getElementById('turf').value,
    obs:document.getElementById('obs').value,
    stance:document.getElementById('stance').value,
    pin:document.getElementById('pin').value,
    green:document.getElementById('green').value,
    notes:document.getElementById('notes').value.trim(),
    time:new Date().toISOString()
  };
}

function ruleTokens(state){
  let tokens=[]; let why=[];
  baseRules.forEach(r=>{ try{ if(r.when(state)){ tokens=tokens.concat(r.add); why.push({add:r.add}); } } catch(e){} });
  if(state.dist<=40 && state.lie!=="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå"){ tokens.push("short_back_long_through","weight_forward","hands_forward"); }
  else if(state.dist>=170 && state.lie!=="‡∏ö‡∏±‡∏á‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏Ç‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏µ‡∏ô"){ tokens.push("swing_smooth","club_up_if_needed"); }
  // Pin bias
  if(state.pin==="left") tokens.push("aim_center_bias");
  if(state.pin==="right") tokens.push("aim_center_bias");
  return {tokens:[...new Set(tokens)], why};
}

// Resolve conflicts: club adjust, ball position, trajectory
function resolveConflicts(tokens){
  let clubAdj=0; // + up, - down
  tokens.forEach(t=>{ if(t==="club_up_0_5") clubAdj+=0.5; if(t==="club_up_1") clubAdj+=1; if(t==="club_down_0_5") clubAdj-=0.5; if(t==="club_down_1") clubAdj-=1; });
  let ballScore=0; // + forward, - back
  tokens.forEach(t=>{ if(t==="ball_forward") ballScore+=1; if(t==="ball_back") ballScore-=1; });
  if(tokens.includes("ball_center_back")) ballScore-=0.5;
  let traj=0; // + high, - low
  tokens.forEach(t=>{ if(t==="traj_low_1") traj-=1; if(t==="traj_low_2") traj-=2; if(t==="traj_high_1") traj+=1; if(t==="traj_high_2") traj+=2; });
  traj += (ballScore>0? +0.5 : ballScore<0? -0.5 : 0);

  const filtered=tokens.filter(t=> !/^club_(up|down)_/.test(t) && !/^traj_/.test(t));
  const finals=[];
  if(Math.abs(clubAdj)<0.25){ finals.push("club_standard"); }
  else if(clubAdj>=0.25 && clubAdj<0.75){ finals.push("club_up_0_5"); }
  else if(clubAdj>=0.75){ finals.push("club_up_1"); }
  else if(clubAdj<=-0.25 && clubAdj>-0.75){ finals.push("club_down_0_5"); }
  else if(clubAdj<=-0.75){ finals.push("club_down_1"); }

  if(ballScore>0.25){ finals.push("ball_forward"); }
  else if(ballScore<-0.25){ finals.push("ball_back"); }
  else { finals.push("ball_center"); }

  if(traj>=1){ finals.push("traj_final_high"); }
  else if(traj<=-1){ finals.push("traj_final_low"); }

  return {tokens:[...new Set(filtered.concat(finals))], clubAdj, ballScore, traj};
}

function toAdvice(tokens, weights){
  const displayText=t=>{ if(t==="traj_final_high") return "‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏ñ‡∏µ‡∏™‡∏π‡∏á (‡∏ï‡∏Å‡∏ô‡∏∏‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏£‡πá‡∏ß)"; if(t==="traj_final_low") return "‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏ñ‡∏µ‡∏ï‡πà‡∏≥ (‡∏Ñ‡∏∏‡∏°‡∏ó‡∏¥‡∏®/‡∏ó‡∏∞‡∏•‡∏∏‡∏•‡∏°)"; return tokenMap[t]||t; };
  const scored=tokens.map(t=>({ token:t, score:(defaultWeight(t)+((weights&&Number.isFinite(weights[t]))?weights[t]:0)), text:displayText(t) })).sort((a,b)=>b.score-a.score);
  const sections=[
    {name:"‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πâ/‡∏à‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞", test:x=>/^club_/.test(x.token) || ["take_enough_carry","full_commit","club_up_if_needed"].includes(x.token)},
    {name:"‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏à‡∏î‡∏•‡∏π‡∏Å/‡πÄ‡∏ã‡πá‡∏ï‡∏≠‡∏±‡∏û", test:x=>/(^ball_)|(^weight_)|(^hands_)|(^widen_)|(^grip_)/.test(x.token)},
    {name:"‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏ß‡∏¥‡∏á/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞", test:x=>/(contact_|normal_|steepen|shallow_|pick_ball|less_sand|splash_sand|accelerate|swing_smooth|short_back|shorter_back|commit_speed|flatter_plane|steeper_plane|hold_loft|open_face|speed_pop|clip_ball|make_divot_en|consider_putt_or_low_chip|reduce_loft_hint)/.test(x.token)},
    {name:"‡∏ó‡∏¥‡∏®/‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° & ‡∏ß‡∏¥‡∏ñ‡∏µ/‡∏•‡∏á‡∏à‡∏≠‡∏î", test:x=>/(^aim_)|(^start_)|(^allow_)|(^traj_final_)|(^land_)/.test(x.token)},
  ];
  const html=[]; sections.forEach(sec=>{ const items=scored.filter(sec.test).slice(0,8); if(items.length){ html.push(`‚Ä¢ <span class="small" style="color:#93c5fd">${sec.name}</span>`); html.push("<ul>"); items.forEach(it=> html.push(`<li>${it.text}</li>`)); html.push("</ul>"); } });
  if(!html.length){ html.push("<ul>"); scored.slice(0,10).forEach(it=> html.push(`<li>${it.text}</li>`)); html.push("</ul>"); }
  const tags=scored.slice(0,8).map(it=> tag(it.text)).join(" ");
  return {html:html.join("
"), tags};
}

let lastState=null, lastTokens=[];
function recommend(){
  const s=currentState(); const wt=loadWeights(); const raw=ruleTokens(s); const resolved=resolveConflicts(raw.tokens);
  lastState=s; lastTokens=resolved.tokens; const advice=toAdvice(resolved.tokens, wt);
  document.getElementById('output').innerHTML=advice.html; document.getElementById('tags').innerHTML=advice.tags;
  document.getElementById('why').textContent=JSON.stringify({state:s, rules:raw, resolved}, null, 2);
  document.getElementById('profileScore').textContent="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: "+profileScore(); addLog({type:"recommend", state:s, tokens:resolved.tokens}); window.scrollTo({top:0, behavior:"smooth"});
}

function sendFeedback(isGood){ if(!lastState){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ' ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞"); return; } const w=loadWeights(); const d=isGood?+1:-1; lastTokens.forEach(t=>{ w[t]=(w[t]||0)+d; }); saveWeights(w); addLog({type:isGood?"good":"bad", state:lastState, tokens:lastTokens, delta:d}); document.getElementById('profileScore').textContent="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: "+profileScore(); const advice=toAdvice(lastTokens, w); document.getElementById('output').innerHTML=advice.html; document.getElementById('tags').innerHTML=advice.tags; }

function addLog(e){ const L=loadLogs(); L.push({...e, ts:new Date().toISOString()}); saveLogs(L); document.getElementById('logCount').textContent = 'logs: '+L.length; }
function saveResult(){ const r={ res_main:document.getElementById('res_main').value, ball_shape:document.getElementById('ball_shape').value, miss_m:+document.getElementById('miss_m').value, state:lastState, ts:new Date().toISOString() }; addLog({type:'result', ...r}); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÅ‡∏•‡πâ‡∏ß'); }

function exportData(){ const data={version:"2.0-pro", weights:loadWeights(), logs:loadLogs()}; const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="golf_shot_profile.json"; a.click(); URL.revokeObjectURL(url); }
function importData(){ const i=document.createElement('input'); i.type="file"; i.accept="application/json"; i.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(d.weights) saveWeights(d.weights); if(d.logs) saveLogs(d.logs); alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); document.getElementById('profileScore').textContent="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: "+profileScore(); document.getElementById('logCount').textContent='logs: '+loadLogs().length; }catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); } }; r.readAsText(f); }; i.click(); }
function clearData(){ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ localStorage.removeItem(KEY); localStorage.removeItem(LOGKEY); document.getElementById('profileScore').textContent='‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: 0'; document.getElementById('logCount').textContent='logs: 0'; alert('‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß'); } }
function resetForm(){ document.getElementById('shotType').value='approach'; document.getElementById('lie').selectedIndex=0; document.getElementById('dist').value=120; document.getElementById('slopeY').value='flat'; document.getElementById('slopeX').value='level'; document.getElementById('wind').value='calm'; document.getElementById('ball').value='normal'; document.getElementById('turf').value='normal'; document.getElementById('obs').value='none'; document.getElementById('stance').value='stable'; document.getElementById('pin').value='center'; document.getElementById('green').value='normal'; document.getElementById('notes').value=''; document.getElementById('output').textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏µ‚Äù'; document.getElementById('tags').innerHTML=''; document.getElementById('why').textContent=''; }

document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('profileScore').textContent="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: "+profileScore(); document.getElementById('logCount').textContent='logs: '+loadLogs().length; });
</script>
</body>
</html>
